<!DOCTYPE html>
<html lang='vi'>
<head>
 <meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
 <title>Cửa Tự Động</title>
 <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
 <style>
  body{background:#f0f2f5;font-family:sans-serif}
  
  /* Tùy chỉnh Card để độ cao bằng nhau và căn giữa */
  .card {
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 15px;
      background: white;
      height: 100%; /* Kéo dãn chiều cao tối đa */
      display: flex;
      flex-direction: column;
      justify-content: center; 
  }

  .box{background:#0d6efd;color:white;padding:10px;border-radius:10px;text-align:center;margin-bottom:10px}
  .num{font-size:3.5rem;font-weight:bold; line-height: 1.2;}
  .st{font-weight:bold;padding:10px;border-radius:20px;display:block;text-align:center;color:white}
  .bg-o{background:#28a745}.bg-c{background:#6c757d}
  .sens{padding:8px;border:1px solid #ccc;border-radius:5px;display:block;text-align:center;margin-top:5px;font-weight:bold;font-size:0.9rem}
  .on{background:#ffc107;color:black;animation:bl 0.5s infinite}
  @keyframes bl{50%{opacity:0.5}}
  #mqtt-status {font-size: 11px; color: gray; text-align: center; margin-bottom: 10px;}
  
  /* Lịch sử */
  .history-box {max-height: 300px; overflow-y: auto; font-size: 0.85rem;}
  .table th, .table td {padding: 0.5rem; vertical-align: middle;}
  .time-col {width: 130px; font-weight: bold; color: #555;}

  /* Nút bấm to hơn */
  .btn-custom { padding: 12px; font-weight: bold; }

  /* Màn hình khóa PIN */
  #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(240, 242, 245, 0.98);
      z-index: 9999; display: flex; justify-content: center; align-items: center;
      flex-direction: column;
  }
  .pin-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 350px; }
  .pin-input { font-size: 2rem; letter-spacing: 10px; text-align: center; margin: 20px 0; font-weight: bold; }
 </style>
</head>
<body>

<!-- Màn hình nhập PIN -->
<div id="login-overlay">
    <div class="pin-box">
        <h4 class="text-primary mb-3">NHẬP MÃ PIN</h4>
        <p class="text-muted">Để truy cập điều khiển cửa</p>
        <input type="password" id="pin-input" class="form-control pin-input" maxlength="4" placeholder="••••">
        <button class="btn btn-primary w-100 py-2 mt-2 fw-bold" onclick="checkPin()">MỞ KHÓA</button>
        <p id="pin-error" class="text-danger mt-2" style="display:none; font-weight:bold;">Sai mã PIN!</p>
    </div>
</div>

<div class='container' style="max-width: 700px;">
 <h3 class='text-center mt-3 text-primary'>Điều khiển cửa</h3>
 <div id="mqtt-status">Chờ nhập PIN...</div>
 
 <div class='row g-3 align-items-stretch'>
  
  <!-- Cột Trái: Trạng thái -->
  <div class='col-md-6'>
      <div class='card'>
        <div class='box'>Số lượng người<div id='cnt' class='num'>--</div></div>
        <div class='row'>
            <div class='col-6'>CỔNG VÀO<span id='so' class='sens'>--</span></div>
            <div class='col-6'>CỔNG RA<span id='si' class='sens'>--</span></div>
        </div>
        <div class='mt-3'><span id='st' class='st bg-c'>--</span></div>
      </div>
  </div>

  <!-- Cột Phải: Điều khiển -->
  <div class='col-md-6'>
      <div class='card'>
        <div class='d-flex justify-content-between mb-4 align-items-center p-2' style="background: #f8f9fa; border-radius: 10px;">
            <b id='md' class="text-uppercase fs-5">--</b>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="adm" onchange="sendCmd('admin', this.checked)">
                <label class="form-check-label" for="adm">Admin</label>
            </div>
        </div>
        
        <div class='btn-group w-100 mb-3'>
            <button id='ba' class='btn btn-outline-secondary btn-custom' onclick="sendCmd('mode','auto')">AUTO</button>
            <button id='bm' class='btn btn-outline-secondary btn-custom' onclick="sendCmd('mode','manual')">MANUAL</button>
        </div>
        
        <div class='d-flex gap-2'>
            <button id='bo' class='btn btn-success w-50 btn-custom' onclick="sendCmd('door','open')" disabled>MỞ CỬA</button>
            <button id='bc' class='btn btn-danger w-50 btn-custom' onclick="sendCmd('door','close')" disabled>ĐÓNG CỬA</button>
        </div>
      </div>
  </div>
  
  <!-- Cột Dưới: Lịch sử -->
  <div class='col-12 mt-3'>
      <div class='card' style="display: block;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Lịch sử ra/vào</h5>
            <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">Xóa log</button>
          </div>
          <div class="history-box">
              <table class="table table-striped table-hover">
                  <thead class="table-dark" style="position: sticky; top: 0;">
                      <tr>
                          <th style="width: 40%">Thời gian</th>
                          <th>Sự kiện</th>
                      </tr>
                  </thead>
                  <tbody id="history-log">
                      <!-- Dữ liệu log -->
                  </tbody>
              </table>
          </div>
      </div>
  </div>

 </div>
</div>

<script>
 // --- CẤU HÌNH MÃ PIN (Bạn có thể đổi số này) ---
 const PIN_CODE = "2301"; 

 // --- CẤU HÌNH HIVEMQ CLOUD ---
 const TOPIC_SUB = "trannam/cua_tu_dong/status"; 
 const TOPIC_PUB = "trannam/cua_tu_dong/cmd";    
 
 // Thông tin Server HiveMQ của bạn
 const host = "c918386ec5d24b1db8bcbcec08162c0a.s1.eu.hivemq.cloud"; 
 const port = 8884; // Cổng WSS
 const username = "trannam";
 const password = "Namtran2301";
 
 const clientID = "Web-Log-" + parseInt(Math.random() * 100000);
 
 let lastData = { cnt: -1, sta: "", mod: "" };

 const client = new Paho.MQTT.Client(host, port, clientID);

 // Hàm kiểm tra PIN
 function checkPin() {
     let input = document.getElementById("pin-input").value;
     if(input === PIN_CODE) {
         document.getElementById("login-overlay").style.display = "none";
         connectMQTT(); // Mở khóa -> Kết nối
     } else {
         document.getElementById("pin-error").style.display = "block";
         document.getElementById("pin-input").value = "";
     }
 }

 function connectMQTT() {
    document.getElementById("mqtt-status").innerText = "Đang kết nối Server...";
    client.connect({
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: () => {
            document.getElementById("mqtt-status").innerText = "Đã kết nối Server Bảo Mật!";
            document.getElementById("mqtt-status").style.color = "green";
            client.subscribe(TOPIC_SUB);
            loadHistory();
        },
        onFailure: (e) => {
            document.getElementById("mqtt-status").innerText = "Lỗi: " + e.errorMessage;
            document.getElementById("mqtt-status").style.color = "red";
        }
    });
 }

 client.onMessageArrived = (msg) => {
    try {
        const d = JSON.parse(msg.payloadString);
        renderUI(d);
        checkAndLog(d);
    } catch(e) { console.log("Lỗi JSON", e); }
 };

 function renderUI(d) {
    document.getElementById('cnt').innerText = d.cnt;
    
    let so = document.getElementById('so');
    so.className = d.so ? 'sens on' : 'sens';
    so.innerText = d.so ? 'CÓ NGƯỜI' : 'Không';
    
    let si = document.getElementById('si');
    si.className = d.si ? 'sens on' : 'sens';
    si.innerText = d.si ? 'CÓ NGƯỜI' : 'Không';
    
    document.getElementById('md').innerText = "CHẾ ĐỘ: " + d.mod.toUpperCase();
    document.getElementById('adm').checked = d.adm;
    
    let st = document.getElementById('st');
    st.innerText = d.sta == 'open' ? 'TRẠNG THÁI: ĐANG MỞ' : 'TRẠNG THÁI: ĐANG ĐÓNG';
    st.className = d.sta == 'open' ? 'st bg-o' : 'st bg-c';
    
    let autoBtn = document.getElementById('ba');
    let manuBtn = document.getElementById('bm');
    let openBtn = document.getElementById('bo');
    let closeBtn = document.getElementById('bc');

    if (d.mod == 'auto') {
        autoBtn.className = 'btn btn-primary btn-custom';
        manuBtn.className = 'btn btn-outline-secondary btn-custom';
        if (!d.adm) { openBtn.disabled = true; closeBtn.disabled = true; }
        else { openBtn.disabled = false; closeBtn.disabled = false; }
    } else {
        manuBtn.className = 'btn btn-primary btn-custom';
        autoBtn.className = 'btn btn-outline-secondary btn-custom';
        openBtn.disabled = false; closeBtn.disabled = false;
    }
 }

 function sendCmd(type, val) {
    if (!client.isConnected()) { alert("Chưa kết nối!"); return; }
    let payload = JSON.stringify({ t: type, v: val.toString() });
    let message = new Paho.MQTT.Message(payload);
    message.destinationName = TOPIC_PUB;
    client.send(message);
    
    if(type == 'door') addLogToTable("Bạn bấm: " + (val=='open'?"Mở cửa":"Đóng cửa"));
    if(type == 'mode') addLogToTable("Đổi chế độ: " + val.toUpperCase());
 }

 // --- XỬ LÝ LỊCH SỬ ---
 function checkAndLog(d) {
     if (lastData.cnt != -1 && d.cnt != lastData.cnt) {
         if (d.cnt > lastData.cnt) 
             addLogToTable(`<span class="text-success fw-bold">⬆ KHÁCH VÀO</span> (Tổng: ${d.cnt})`);
         else 
             addLogToTable(`<span class="text-danger fw-bold">⬇ KHÁCH RA</span> (Tổng: ${d.cnt})`);
     }

     if (lastData.sta != "" && d.sta != lastData.sta) {
         if (d.sta == 'open') addLogToTable("Cửa đã MỞ");
         if (d.sta == 'close') addLogToTable("Cửa đã ĐÓNG");
     }

     lastData.cnt = d.cnt;
     lastData.sta = d.sta;
     lastData.mod = d.mod;
 }

 function addLogToTable(msg) {
     let table = document.getElementById('history-log');
     let now = new Date();
     let timeString = `<small>${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}</small> <b>${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}</b>`;
     let row = `<tr><td class="time-col">${timeString}</td><td>${msg}</td></tr>`;
     table.innerHTML = row + table.innerHTML; 
     saveHistory(); 
 }

 function saveHistory() {
     let tableContent = document.getElementById('history-log').innerHTML;
     localStorage.setItem('door_history_v2', tableContent);
 }

 function loadHistory() {
     let saved = localStorage.getItem('door_history_v2');
     if (saved) document.getElementById('history-log').innerHTML = saved;
 }

 function clearHistory() {
     if(confirm("Xóa toàn bộ lịch sử?")) {
        document.getElementById('history-log').innerHTML = "";
        localStorage.removeItem('door_history_v2');
     }
 }
</script>
</body>
</html>
